{% extends 'base.html' %}
{% load static %}

{% block main %}
    <main class="container my-5">
        <div class="row">
            <div class="col-md-6">
                <h2>未通过审核</h2>
                <ul class="list-group">
                    {% for post in unapproved_posts %}
                        <li class="list-group-item">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#postModal"
                               data-post-id="{{ post.id }}">{{ post.title }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-6">
                <h2>已通过审核</h2>
                <ul class="list-group">
                    {% for post in approved_posts %}
                        <li class="list-group-item">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#postModal"
                               data-post-id="{{ post.id }}">{{ post.title }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </main>

    <!-- 模态框 -->
    <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postModalLabel">帖子详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="postModalBody">
                    <!-- 帖子内容将在这里显示 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="approvePost">通过审核</button>
                    <button type="button" class="btn btn-danger" id="unapprovePost">降级审核</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // 点击帖子链接时加载帖子内容
            $('a[data-bs-toggle="modal"]').click(function () {
                var postId = $(this).data('post-id');
                $.ajax({
                    url: '/get_post/' + postId + '/',
                    success: function (data) {
                        // 清空模态框内容
                        $('#postModalBody').empty();
                        // 添加帖子标题
                        $('#postModalBody').append('<h3>' + data.title + '</h3>');
                        // 添加帖子内容
                        $('#postModalBody').append('<p>' + data.content + '</p>');
                        // 添加作者和创建时间
                        $('#postModalBody').append('<p>作者: ' + data.author + '</p>');
                        $('#postModalBody').append('<p>创建时间: ' + data.created_at + '</p>');
                        // 设置帖子 ID
                        $('#postModalBody').data('post-id', postId);
                    },
                    error: function () {
                        $('#postModalBody').html('<p>加载帖子内容失败。</p>');
                    }
                });
            });

            // 审核帖子
            $('#approvePost').click(function () {
                var postId = $('#postModalBody').data('post-id');
                $.ajax({
                    url: '/approve_post/' + postId + '/',
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        post_id: postId
                    },
                    success: function (data) {
                        $('#postModal').modal('hide');
                        location.reload(); // 刷新页面
                    },
                    error: function () {
                        alert('审核失败');
                    }
                });
            });

            // 降级审核帖子
            $('#unapprovePost').click(function () {
                var postId = $('#postModalBody').data('post-id');
                $.ajax({
                    url: '/unapprove_post/' + postId + '/',
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        post_id: postId
                    },
                    success: function (data) {
                        $('#postModal').modal('hide');
                        location.reload(); // 刷新页面
                    },
                    error: function () {
                        alert('降级审核失败');
                    }
                });
            });
        });
    </script>
{% endblock %}